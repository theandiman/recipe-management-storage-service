steps:
  # Configure Maven settings to authenticate to Artifact Registry via an access token
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'configure-maven-settings'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        mkdir -p /workspace/.m2
        # Generate a minimal Maven settings.xml with server credentials for Artifact Registry
        # This avoids reliance on gcloud's print-settings subcommand which may not be available
        cat > /workspace/.m2/settings.xml <<'SETTINGS'
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>gcp-maven-proxy</id>
              <username>oauth2accesstoken</username>
              <password>@@ACCESS_TOKEN@@</password>
            </server>
          </servers>
        </settings>
        SETTINGS
        # Replace placeholder with runtime access token (error out if token cannot be retrieved)
        # Replace placeholder in the settings.xml with a runtime access token
        sed -i "s|@@ACCESS_TOKEN@@|$(gcloud auth print-access-token)|g" /workspace/.m2/settings.xml
        # Verify the token is populated; fail if empty to avoid unauthorized Maven requests
        if ! grep -q -E "<password>[^<]+</password>" /workspace/.m2/settings.xml; then
          echo "ERROR: settings.xml not properly configured with access token"
          exit 1
        fi

  # Run Maven tests (parallel with linting)
  - name: 'maven:3.9-eclipse-temurin-21'
    id: 'test-storage'
    entrypoint: 'mvn'
    args: ['-s', '/workspace/.m2/settings.xml', 'test', '-B', '-Dmaven.repo.local=/workspace/.m2/repository']
    waitFor: ['configure-maven-settings']  # Wait for Maven settings to be configured

  # Run linting (Checkstyle) - parallel with tests
  - name: 'maven:3.9-eclipse-temurin-21'
    id: 'lint-storage'
    entrypoint: 'mvn'
    args: ['-s', '/workspace/.m2/settings.xml', 'validate', '-B', '-Dmaven.repo.local=/workspace/.m2/repository']
    waitFor: ['configure-maven-settings']  # Wait for Maven settings to be configured

  # Build the application JAR (skip on PR builds)
  - name: 'maven:3.9-eclipse-temurin-21'
    id: 'build-storage'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        
        echo "Building application package..."
        mvn -s /workspace/.m2/settings.xml package -DskipTests -B -Dmaven.repo.local=/workspace/.m2/repository
    waitFor: ['test-storage', 'lint-storage']  # Wait for tests and linting to complete

  # Build Docker image - ONLY on main branch
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        
        echo "Building Docker image..."
        docker build -t ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:${SHORT_SHA} \
                     -t ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest .

  # Push Docker image - ONLY on main branch
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Only push image on main branch
        if [ "$BRANCH_NAME" != "main" ]; then
          echo "PR build detected (branch: $BRANCH_NAME), skipping Docker push"
          exit 0
        fi
        
        echo "Pushing Docker image..."
        docker push ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:${SHORT_SHA}
        docker push ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest

  # Deploy new image to Cloud Run - ONLY on main branch
  # Note: Only updates the image, other config managed by Terraform
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-storage'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Only deploy on main branch
        if [ "$BRANCH_NAME" != "main" ]; then
          echo "PR build detected (branch: $BRANCH_NAME), skipping deployment"
          exit 0
        fi
        
        echo "Deploying new image to Cloud Run..."
        gcloud run services update ${_SERVICE_NAME} \
          --image ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest \
          --region ${_REGION}
        
        echo "Deployment complete âœ“"

  # OWASP ZAP Security Scan - ONLY on main branch after deployment
  - name: 'ghcr.io/zaproxy/zaproxy:stable'
    id: 'security-scan-zap'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Only run on main branch after deployment
        if [ "$BRANCH_NAME" != "main" ]; then
          echo "PR build detected (branch: $BRANCH_NAME), skipping OWASP ZAP scan"
          exit 0
        fi
        
        # Get the service URL
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region ${_REGION} \
          --format='value(status.url)')
        
        echo "Running OWASP ZAP baseline scan against $SERVICE_URL"
        
        # Run ZAP baseline scan (passive scan only, safe for production)
        # -t: target URL
        # -g: generate config file
        # -m: maximum time in minutes
        # -r: HTML report name
        # -w: markdown report name
        # -J: JSON report name
        # -l: minimum risk level to fail the build (HIGH)
        # -I: ignore informational level findings in reports
        zap-baseline.py -t "$SERVICE_URL" \
          -g gen.conf \
          -m 5 \
          -r /workspace/zap-report.html \
          -w /workspace/zap-report.md \
          -J /workspace/zap-report.json \
          -l HIGH -I
        
        echo "ZAP scan complete. Reports saved to /workspace/zap-report.*"
    waitFor: ['deploy-storage']

  # Upload ZAP reports to Cloud Storage - ONLY on main branch
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'upload-zap-reports'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Only upload on main branch
        if [ "$BRANCH_NAME" != "main" ]; then
          echo "PR build detected (branch: $BRANCH_NAME), skipping ZAP report upload"
          exit 0
        fi
        
        # Create bucket if it doesn't exist (suppress error if exists)
        gsutil mb -p ${PROJECT_ID} -l ${_REGION} gs://${PROJECT_ID}-security-reports 2>/dev/null || true
        
        # Upload reports with timestamp
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        gsutil -m cp /workspace/zap-report.* \
          gs://${PROJECT_ID}-security-reports/${_SERVICE_NAME}/zap/${TIMESTAMP}/
        
        echo "ZAP reports uploaded to gs://${PROJECT_ID}-security-reports/${_SERVICE_NAME}/zap/${TIMESTAMP}/"
        
        # Make the HTML report publicly readable (optional)
        gsutil iam ch allUsers:objectViewer \
          gs://${PROJECT_ID}-security-reports/${_SERVICE_NAME}/zap/${TIMESTAMP}/zap-report.html || true
        
        echo "View report: https://storage.googleapis.com/${PROJECT_ID}-security-reports/${_SERVICE_NAME}/zap/${TIMESTAMP}/zap-report.html"
    waitFor: ['security-scan-zap']

# Substitutions for different environments
substitutions:
  _SERVICE_NAME: 'recipe-storage-service'
  _REGION: 'europe-west2'
  _ARTIFACT_REGISTRY_REPO: 'recipe-storage'

# Use faster machine type for builds
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  # Enable caching for faster builds
  volumes:
  - name: 'm2'
    path: '/workspace/.m2'

# Timeout after 10 minutes (reduced from 20)
timeout: '600s'
